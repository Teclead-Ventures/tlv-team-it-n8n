name: n8n Smart Sync

on:
  push:
    branches: ["main"]
    paths:
      - "workflows/**"
      - ".github/workflows/n8n-smart-sync.yml"
      - "scripts/smart-sync-workflows.mjs"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (validate only, no changes applied)"
        type: boolean
        default: false
      force_update:
        description: "Force update all workflows (ignore change detection)"
        type: boolean
        default: false

jobs:
  validate-workflows:
    runs-on: ubuntu-latest
    outputs:
      workflow_count: ${{ steps.count.outputs.count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Count workflows
        id: count
        run: |
          count=$(find workflows -name "*.json" | wc -l)
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "📋 Found $count workflow files"

      - name: Validate JSON syntax
        run: |
          echo "🔍 Validating JSON syntax of workflow files..."
          for file in $(find workflows -name "*.json"); do
            echo "Checking: $file"
            if ! node -e "JSON.parse(require('fs').readFileSync('$file', 'utf8')); console.log('✅ Valid: $file')"; then
              echo "❌ Invalid JSON in: $file"
              exit 1
            fi
          done
          echo "✅ All workflow files have valid JSON syntax"

  smart-sync:
    needs: validate-workflows
    if: needs.validate-workflows.outputs.workflow_count > 0
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Smart Sync Workflows
        run: |
          echo "🔄 Starting smart workflow synchronization..."
          echo "📊 Processing ${{ needs.validate-workflows.outputs.workflow_count }} workflows"
          node scripts/smart-sync-workflows.mjs
        env:
          N8N_BASE_URL: ${{ secrets.N8N_BASE_URL }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}

      - name: Report Results
        if: always()
        run: |
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "🔍 DRY RUN completed - no changes were applied"
            echo "💡 Run workflow again with dry_run=false to apply changes"
          else
            echo "✅ Smart sync completed successfully"
            echo "🔗 Check workflow logs above for detailed results"
          fi
